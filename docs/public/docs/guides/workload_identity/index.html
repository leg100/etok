<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta name="generator" content="Hugo 0.80.0" />
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Workload Identity #  Workload Identity lets GKE pods assume privileges to Google Cloud without the use of credentials. Etok can use Workload Identity both for terraform and for the operator: terraform can use it to authorize the Google Cloud provider to manage Google Cloud resources; the operator can use it to perform state backups.
Terminology #  With Workload Identity, you configure a Kubernetes service account to act as a Google service account.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Workload Identity" />
<meta property="og:description" content="Workload Identity #  Workload Identity lets GKE pods assume privileges to Google Cloud without the use of credentials. Etok can use Workload Identity both for terraform and for the operator: terraform can use it to authorize the Google Cloud provider to manage Google Cloud resources; the operator can use it to perform state backups.
Terminology #  With Workload Identity, you configure a Kubernetes service account to act as a Google service account." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://docs.etok.dev/docs/guides/workload_identity/" />

<title>Workload Identity | Etok Documentation</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.df6f869cde214e45a535b56ab1bc0d62e6f3ab280b0d39c0b9dcc71a7b205ed2.css" integrity="sha256-32&#43;GnN4hTkWlNbVqsbwNYubzqygLDTnAudzHGnsgXtI=">
<script defer src="/en.search.min.68efaf2fed99057d51f15574c24b623c1d7b2859f45f0a6c732681b5e76c7cc8.js" integrity="sha256-aO&#43;vL&#43;2ZBX1R8VV0wktiPB17KFn0XwpscyaBtedsfMg="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="/"><span>Etok Documentation</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Tutorials</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/tutorials/getting_started/" class="">Getting Started</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Guides</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/guides/state_backup/" class="">State Backup</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/guides/workload_identity/" class=" active">Workload Identity</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Reference</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/operator_install/" class="">Operator Install</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/access_control/" class="">Access Control</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/commands/" class="">Commands</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/commands/terraform/" class="">Terraform</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/commands/additional/" class="">Additional</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/credentials/" class="">Credentials</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/restrictions/" class="">Restrictions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/state/" class="">State</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/reference/testing/" class="">Testing</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Background</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/background/configuration_upload/" class="">Configuration Upload</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/background/performance_optimization/" class="">Performance Optimization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://docs.etok.dev/docs/background/crds/" class="">CRDs</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/leg100/etok" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://join.slack.com/t/etokworkspace/shared_invite/zt-lbqgojdj-IS6aDIydMXe2X3EYf8ZRow" target="_blank" rel="noopener">
        Slack
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Workload Identity</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#terminology">Terminology</a></li>
    <li><a href="#guide">Guide</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="workload-identity">
  Workload Identity
  <a class="anchor" href="#workload-identity">#</a>
</h1>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity</a> lets GKE pods assume privileges to Google Cloud without the use of credentials. Etok can use Workload Identity both for terraform and for the operator: terraform can use it to authorize the <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs">Google Cloud</a> provider to manage Google Cloud resources; the operator can use it to perform <a href="https://docs.etok.dev/docs/guides/state_backup/">state backups</a>.</p>
<h2 id="terminology">
  Terminology
  <a class="anchor" href="#terminology">#</a>
</h2>
<p>With Workload Identity, you configure a Kubernetes service account to act as a Google service account. The following acronyms will be used to clearly differentiate between the two types of service account:</p>
<ul>
<li>KSA: Kubernetes Service Account</li>
<li>GSA: Google Service Account</li>
</ul>
<h2 id="guide">
  Guide
  <a class="anchor" href="#guide">#</a>
</h2>
<p>This guide provides instructions for setting up workload identity both for terraform and for state backups.</p>




<div class="book-tabs"><input type="radio" class="toggle" name="tabs-workload_identity" id="tabs-workload_identity-0" checked="checked" />
  <label for="tabs-workload_identity-0">Terraform</label>
  <div class="book-tabs-content markdown-inner"><ol>
<li>
<p>Ensure your GKE cluster has Workload Identity <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_on_cluster">enabled</a>.</p>
</li>
<li>
<p>Create a GSA if you haven&rsquo;t got one already:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud iam service-accounts create GSA_NAME
</code></pre></div></li>
<li>
<p><a href="https://cloud.google.com/iam/docs/granting-changing-revoking-access#granting-gcloud-manual">Grant</a> IAM privileges to the GSA. For example, assign the compute engine admin IAM role to permit <code>terraform apply</code> to create VMs in a Google Cloud project via the <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_instance"><code>google_compute_instance</code></a> resource:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud projects add-iam-policy-binding <span style="color:#f92672">[</span>PROJECT_ID<span style="color:#f92672">]</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --member<span style="color:#f92672">=</span>serviceAccount:<span style="color:#f92672">[</span>GSA_EMAIL<span style="color:#f92672">]</span> --role roles/compute.admin
</code></pre></div></li>
<li>
<p>You now need to determine the KSA to use. Etok configures pods with a KSA named <code>etok</code> in the given namespace. For instance, if your workspace is in the namespace <code>dev</code>, then any terraform commands you run on that workspace will use the KSA <code>dev/etok</code>. When you create a workspace for the first time in a namespace, a KSA named <code>etok</code> is automatically created. If you haven&rsquo;t yet created a workspace, then you can manually create the KSA:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create serviceaccount etok --namespace <span style="color:#f92672">[</span>NAMESPACE<span style="color:#f92672">]</span>
</code></pre></div><p>To allow the KSA to impersonate the GSA, create an IAM policy between the two:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud iam service-accounts add-iam-policy-binding <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --role roles/iam.workloadIdentityUser <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --member <span style="color:#e6db74">&#34;serviceAccount:[PROJECT_ID].svc.id.goog[NAMESPACE/etok]&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#f92672">[</span>GSA_NAME<span style="color:#f92672">]</span>@<span style="color:#f92672">[</span>GSA_PROJECT_ID<span style="color:#f92672">]</span>.iam.gserviceaccount.com
</code></pre></div><p>Where PROJECT_ID is the project of the GKE cluster, NAMESPACE is the namespace of the KSA named <code>etok</code>, and GSA_PROJECT_ID is the project of the GSA.</p>
</li>
<li>
<p>Annotate the KSA with details of the GSA it is impersonating:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl annotate serviceaccounts --namespace <span style="color:#f92672">[</span>NAMESPACE<span style="color:#f92672">]</span> etok <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    iam.gke.io/gcp-service-account<span style="color:#f92672">=[</span>GSA_NAME<span style="color:#f92672">]</span>@<span style="color:#f92672">[</span>PROJECT_ID<span style="color:#f92672">]</span>.iam.gserviceaccount.com
</code></pre></div></li>
<li>
<p>Create a workspace if you haven&rsquo;t already:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">etok workspace new --namespace NAMESPACE WORKSPACE_NAME
</code></pre></div></li>
<li>
<p>Write some terraform configuration to deploy a VM in Google Cloud:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;google_compute_instance&#34;</span> <span style="color:#e6db74">&#34;default&#34;</span> {
  <span style="color:#a6e22e">name</span>         = <span style="color:#e6db74">&#34;test&#34;</span>
  <span style="color:#a6e22e">machine_type</span> = <span style="color:#e6db74">&#34;e2-medium&#34;</span>
  <span style="color:#a6e22e">zone</span>         = <span style="color:#e6db74">&#34;europe-west2-a&#34;</span>
  <span style="color:#a6e22e">project</span>      = <span style="color:#e6db74">&#34;[PROJECT_ID]&#34;</span>

  <span style="color:#a6e22e">boot_disk</span> {
    <span style="color:#a6e22e">initialize_params</span> {
      <span style="color:#a6e22e">image</span> = <span style="color:#e6db74">&#34;debian-cloud/debian-9&#34;</span>
    }
  }

  <span style="color:#a6e22e">network_interface</span> {
    <span style="color:#a6e22e">network</span> = <span style="color:#e6db74">&#34;default&#34;</span>

    <span style="color:#a6e22e">access_config</span> {<span style="color:#75715e">
</span><span style="color:#75715e">      // Ephemeral IP
</span><span style="color:#75715e"></span>    }
  }
}
</code></pre></div></li>
<li>
<p>Run <code>etok init</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">etok init
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Initializing the backend...

Successfully configured the backend &#34;kubernetes&#34;! Terraform will automatically
use this backend unless the backend configuration changes.

Initializing provider plugins...
- Reusing previous version of hashicorp/random from the dependency lock file
- Finding latest version of hashicorp/google...
- Installing hashicorp/google v3.56.0...
- Installed hashicorp/google v3.56.0 (signed by HashiCorp)
- Installing hashicorp/random v3.0.1...
- Installed hashicorp/random v3.0.1 (signed by HashiCorp)

Terraform has made some changes to the provider dependency selections recorded
in the .terraform.lock.hcl file. Review those changes and commit them to your
version control system if they represent changes you intended to make.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &#34;terraform plan&#34; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
</code></pre></div></li>
<li>
<p>Run <code>etok apply</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">etok apply
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # google_compute_instance.default will be created
  + resource &#34;google_compute_instance&#34; &#34;default&#34; {
      + can_ip_forward       = false
      + cpu_platform         = (known after apply)
      + current_status       = (known after apply)
      + deletion_protection  = false
      + guest_accelerator    = (known after apply)
      + id                   = (known after apply)
      + instance_id          = (known after apply)
      + label_fingerprint    = (known after apply)
      + machine_type         = &#34;e2-medium&#34;
      + metadata_fingerprint = (known after apply)
      + min_cpu_platform     = (known after apply)
      + name                 = &#34;test&#34;
      + project              = &#34;automatize-admin&#34;
      + self_link            = (known after apply)
      + tags_fingerprint     = (known after apply)
      + zone                 = &#34;europe-west2-a&#34;

      + boot_disk {
          + auto_delete                = true
          + device_name                = (known after apply)
          + disk_encryption_key_sha256 = (known after apply)
          + kms_key_self_link          = (known after apply)
          + mode                       = &#34;READ_WRITE&#34;
          + source                     = (known after apply)

          + initialize_params {
              + image  = &#34;debian-cloud/debian-9&#34;
              + labels = (known after apply)
              + size   = (known after apply)
              + type   = (known after apply)
            }
        }

      + confidential_instance_config {
          + enable_confidential_compute = (known after apply)
        }

      + network_interface {
          + name               = (known after apply)
          + network            = &#34;default&#34;
          + network_ip         = (known after apply)
          + subnetwork         = (known after apply)
          + subnetwork_project = (known after apply)

          + access_config {
              + nat_ip       = (known after apply)
              + network_tier = (known after apply)
            }
        }

      + scheduling {
          + automatic_restart   = (known after apply)
          + on_host_maintenance = (known after apply)
          + preemptible         = (known after apply)

          + node_affinities {
              + key      = (known after apply)
              + operator = (known after apply)
              + values   = (known after apply)
            }
        }
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only &#39;yes&#39; will be accepted to approve.

  Enter a value: yes

google_compute_instance.default: Creating...
google_compute_instance.default: Still creating... [10s elapsed]
google_compute_instance.default: Creation complete after 14s [id=projects/automatize-admin/zones/europe-west2-a/instances/test]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
</code></pre></div><p>This demonstrates terraform has been able to use the privileges conferred by workload identity.</p>
</li>
</ol>
</div><input type="radio" class="toggle" name="tabs-workload_identity" id="tabs-workload_identity-1"  />
  <label for="tabs-workload_identity-1">Backups</label>
  <div class="book-tabs-content markdown-inner"><ol>
<li>
<p>Ensure your GKE cluster has Workload Identity <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_on_cluster">enabled</a>.</p>
</li>
<li>
<p>Create a GSA if you haven&rsquo;t got one already:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud iam service-accounts create GSA_NAME
</code></pre></div></li>
<li>
<p><a href="https://cloud.google.com/iam/docs/granting-changing-revoking-access#granting-gcloud-manual">Grant</a> sufficient IAM privileges to the GSA on the GCS bucket you&rsquo;ll use for backups. See the <a href="https://docs.etok.dev/docs/guides/state_backup/">state backups</a> guide for the exact permissions.</p>
</li>
<li>
<p>Allow the etok operator KSA to impersonate the GSA, create an IAM policy between the two:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud iam service-accounts add-iam-policy-binding <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --role roles/iam.workloadIdentityUser <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --member <span style="color:#e6db74">&#34;serviceAccount:[PROJECT_ID].svc.id.goog[etok/etok]&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#f92672">[</span>GSA_NAME<span style="color:#f92672">]</span>@<span style="color:#f92672">[</span>GSA_PROJECT_ID<span style="color:#f92672">]</span>.iam.gserviceaccount.com
</code></pre></div><p><code>[etok/etok]</code> refers to the KSA named <code>etok</code> in the namespace <code>etok</code>, which is the default for the operator install. PROJECT_ID is the project of the GKE cluster, and GSA_PROJECT_ID is the project of the GSA.</p>
</li>
<li>
<p>Now follow the <a href="https://docs.etok.dev/docs/guides/state_backup/">state backups</a> guide to install or upgrade the operator with necessary backup provider configuration as well as the necessary service account annotation to complete the configuration of workoad identity for backups.</p>
</li>
</ol>
</div></div>

</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





  <div>
    <a class="flex align-center" href="https://github.com/leg100/etok/edit/master/docs/content//docs/guides/workload_identity.md" target="_blank" rel="noopener">
      <img src="/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>

</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#terminology">Terminology</a></li>
    <li><a href="#guide">Guide</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>

</html>












